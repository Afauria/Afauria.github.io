<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico">
  <link rel="mask-icon" href="/images/favicon.ico" color="#222">
  <meta name="google-site-verification" content="4Wnft1QE2BfTMnTv4w9h6ObQ3JsndZpCHnOeGa3YUuo">
  <meta name="baidu-site-verification" content="code-c502xbTetv">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.afauria.xyz","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="介绍Dart虚拟机，Dart程序的编译和执行。Dart SDK源码下载和编译。语言基础不做详细介绍，直接引用官网资料">
<meta property="og:type" content="article">
<meta property="og:title" content="Dart的编译和执行原理">
<meta property="og:url" content="https://blog.afauria.xyz/2022/01/05/flutter-2022-01-05-Dart%E7%9A%84%E7%BC%96%E8%AF%91%E5%92%8C%E6%89%A7%E8%A1%8C/index.html">
<meta property="og:site_name" content="Afauria&#39;s Blog">
<meta property="og:description" content="介绍Dart虚拟机，Dart程序的编译和执行。Dart SDK源码下载和编译。语言基础不做详细介绍，直接引用官网资料">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.afauria.xyz/2022/01/05/flutter-2022-01-05-Dart%E7%9A%84%E7%BC%96%E8%AF%91%E5%92%8C%E6%89%A7%E8%A1%8C/dart%E5%B7%A5%E5%85%B7.png">
<meta property="og:image" content="https://blog.afauria.xyz/2022/01/05/flutter-2022-01-05-Dart%E7%9A%84%E7%BC%96%E8%AF%91%E5%92%8C%E6%89%A7%E8%A1%8C/DartVM.png">
<meta property="og:image" content="https://blog.afauria.xyz/2022/01/05/flutter-2022-01-05-Dart%E7%9A%84%E7%BC%96%E8%AF%91%E5%92%8C%E6%89%A7%E8%A1%8C/dart%E7%BC%96%E8%AF%91%E4%BA%A7%E7%89%A9%E6%96%87%E4%BB%B6.png">
<meta property="og:image" content="https://blog.afauria.xyz/2022/01/05/flutter-2022-01-05-Dart%E7%9A%84%E7%BC%96%E8%AF%91%E5%92%8C%E6%89%A7%E8%A1%8C/dart%E5%91%BD%E4%BB%A4%E5%B8%AE%E5%8A%A9.png">
<meta property="article:published_time" content="2022-01-04T16:00:00.000Z">
<meta property="article:modified_time" content="2022-03-04T08:46:57.062Z">
<meta property="article:author" content="Afauria">
<meta property="article:tag" content="Flutter">
<meta property="article:tag" content="Dart">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.afauria.xyz/2022/01/05/flutter-2022-01-05-Dart%E7%9A%84%E7%BC%96%E8%AF%91%E5%92%8C%E6%89%A7%E8%A1%8C/dart%E5%B7%A5%E5%85%B7.png">

<link rel="canonical" href="https://blog.afauria.xyz/2022/01/05/flutter-2022-01-05-Dart%E7%9A%84%E7%BC%96%E8%AF%91%E5%92%8C%E6%89%A7%E8%A1%8C/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Dart的编译和执行原理 | Afauria's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Afauria's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">丘山月夜的博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="user fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-knowledge">

    <a href="/KnowledgeTree/" rel="section"><i class="graduation-cap fa fa-graduation-cap fa-fw"></i>知识体系</a>

  </li>
        <li class="menu-item menu-item-collection">

    <a href="/collection/" rel="section"><i class="suitcase fa fa-suitcase fa-fw"></i>收藏</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.afauria.xyz/2022/01/05/flutter-2022-01-05-Dart%E7%9A%84%E7%BC%96%E8%AF%91%E5%92%8C%E6%89%A7%E8%A1%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Afauria">
      <meta itemprop="description" content="君は空を見てるか,<br>風の音を聞いてるか">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Afauria's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Dart的编译和执行原理
        </h1>

        <div class="post-meta">
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-05 00:00:00" itemprop="dateCreated datePublished" datetime="2022-01-05T00:00:00+08:00">2022-01-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-03-04 16:46:57" itemprop="dateModified" datetime="2022-03-04T16:46:57+08:00">2022-03-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Flutter/" itemprop="url" rel="index"><span itemprop="name">Flutter</span></a>
                </span>
            </span>

          
            <span id="/2022/01/05/flutter-2022-01-05-Dart%E7%9A%84%E7%BC%96%E8%AF%91%E5%92%8C%E6%89%A7%E8%A1%8C/" class="post-meta-item leancloud_visitors" data-flag-title="Dart的编译和执行原理" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/05/flutter-2022-01-05-Dart%E7%9A%84%E7%BC%96%E8%AF%91%E5%92%8C%E6%89%A7%E8%A1%8C/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/05/flutter-2022-01-05-Dart%E7%9A%84%E7%BC%96%E8%AF%91%E5%92%8C%E6%89%A7%E8%A1%8C/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>16k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>15 分钟</span>
            </span>
            <div class="post-description">介绍Dart虚拟机，Dart程序的编译和执行。Dart SDK源码下载和编译。语言基础不做详细介绍，直接引用官网资料</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Dart简介"><a href="#Dart简介" class="headerlink" title="Dart简介"></a>Dart简介</h1><p><a target="_blank" rel="noopener" href="https://dart.dev/overview">官方网站</a></p>
<p>目标是高效地开发多平台应用，提供灵活的运行时环境和编译工具。</p>
<blockquote>
<p>理论上所有高级语言都可跨平台，关键在于语法、平台库好不好用，编译工具成不成熟。下面会详细介绍下Dart的编译和执行</p>
</blockquote>
<h2 id="Dart-SDK安装"><a href="#Dart-SDK安装" class="headerlink" title="Dart SDK安装"></a>Dart SDK安装</h2><p>参考<a target="_blank" rel="noopener" href="https://dart.dev/get-dart">Dart SDK安装</a>。Dart SDK中包含了Dart核心库、编译器、命令行工具等。Dart SDK是由Dart源码编译出来的归档文件。</p>
<ul>
<li>Flutter SDK内置了Dart SDK工具（Dart SDK归档文件，包括工具和核心库），位于<code>&#123;flutter_sdk&#125;/bin/cache/dart-sdk</code>中，不需要再单独下载。</li>
<li>Flutter Engine中依赖了Dart的源码，位于<code>&#123;flutter_engine&#125;/third_party/dart</code>中，通过ninja构建出Dart SDK可执行程序，供Flutter SDK使用。</li>
</ul>
<h2 id="Dart语言"><a href="#Dart语言" class="headerlink" title="Dart语言"></a>Dart语言</h2><p>支持众多特性：类型安全（静态类型检查、dynamic运行时检查）、空安全、异步调用、流、箭头函数、getter函数等。基本语法参考<a target="_blank" rel="noopener" href="https://dart.dev/guides/language/language-tour">Dart语言</a></p>
<h2 id="Dart库"><a href="#Dart库" class="headerlink" title="Dart库"></a>Dart库</h2><p><a target="_blank" rel="noopener" href="https://dart.dev/guides/libraries">核心库</a>和<a target="_blank" rel="noopener" href="https://dart.dev/guides/libraries/useful-libraries">三方库</a></p>
<h2 id="Dart项目文件"><a href="#Dart项目文件" class="headerlink" title="Dart项目文件"></a>Dart项目文件</h2><p>Dart使用<code>pubspec.yaml</code>文件保存项目信息、发布信息、依赖包等。<a target="_blank" rel="noopener" href="https://dart.dev/tools/pub/pubspec">pubspec说明</a></p>
<blockquote>
<p>类似npm的<code>package.json</code>，本地会缓存依赖包，不同项目可以共用本地缓存的依赖包</p>
</blockquote>
<p>可以使用<code>dart pub &lt;subcommand&gt;</code>命令管理项目，如add添加依赖，get获取依赖等。可以用<code>dart pub -h</code>查看帮助，也可以看<a target="_blank" rel="noopener" href="https://dart.dev/tools/pub/cmd">dart pub说明</a></p>
<blockquote>
<p><strong>如果用dart开发Flutter程序，使用<code>flutter pub &lt;subcommand&gt;</code>命令替代，flutter对dart命令进行了一层包装</strong></p>
</blockquote>
<p>新建<code>pubspec.yaml</code>文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">myapp</span> <span class="comment"># 项目名称</span></span><br><span class="line"></span><br><span class="line"><span class="attr">environment:</span> <span class="comment"># dart版本</span></span><br><span class="line">  <span class="attr">sdk:</span> <span class="string">&quot;&gt;=2.12.0 &lt;3.0.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dependencies:</span>  <span class="comment"># 依赖包</span></span><br><span class="line">  <span class="attr">js:</span> <span class="string">^0.6.0</span></span><br></pre></td></tr></table></figure>

<p>执行<code>dart pub get</code>获取依赖，会生成几个文件。不需要提交，加到<code>.gitignore</code>中</p>
<ol>
<li><code>pubspec.lock</code>：保存项目信息</li>
<li><code>.packages</code>：已经弃用，替换为<code>package_config.json</code>文件</li>
<li><code>.dart_tool/package_config.json</code>：将依赖包映射到系统缓存该包的路径</li>
</ol>
<p><code>main.dart</code>中可以导入包使用，运行时会从<code>package_config.json</code>中查找依赖包路径</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:js/js.dart&#x27;</span> <span class="keyword">as</span> js;</span><br></pre></td></tr></table></figure>

<p><code>dart compile</code>和<code>dart --snapshot</code>可以使用<code>--packages=&lt;path&gt;</code>选项指定<code>.packages</code>文件或者<code>package_config.json</code>文件，用于编译时查找依赖包路径</p>
<h2 id="Dart工具"><a href="#Dart工具" class="headerlink" title="Dart工具"></a>Dart工具</h2><p>Dart SDK中提供了一些工具，使用<code>-h</code>查看帮助或者参考<a target="_blank" rel="noopener" href="https://dart.dev/tools/dart-tool">Dart命令行工具</a>。源码入口位于<code>&#123;dart_sdk&#125;/pkg/dartdev/</code>中</p>
<p><img src="/2022/01/05/flutter-2022-01-05-Dart%E7%9A%84%E7%BC%96%E8%AF%91%E5%92%8C%E6%89%A7%E8%A1%8C/dart%E5%B7%A5%E5%85%B7.png"></p>
<ul>
<li><code>dart</code>：用于创建、格式化、分析、测试、编译和运行dart代码</li>
<li><code>dartaotruntime</code>：用于执行aot预编译过机器码</li>
<li><code>dartdoc</code>：用于生成API文档</li>
</ul>
<p>除了上面三个工具外，还有<code>dart2js</code>、<code>dart2native</code>、<code>dartanalyzer</code>、<code>dartdevc</code>、<code>dartfmt</code>、<code>pub</code>等工具。这些工具从2.10版本开始全部被封装到了<code>dart</code>中，通过<code>dart &lt;subcommand&gt;</code>的方式执行：</p>
<ul>
<li><code>dart2native</code>, <code>dart2aot</code>,  <code>dart2js</code> 工具被 <code>dart compile</code> 替代</li>
<li><code>dartanalyzer</code>被<code>dart analyze</code>替代</li>
<li><code>dartfmt</code>被<code>dart format</code>替代</li>
<li><code>pub</code>被<code>dart pub</code>替代</li>
</ul>
<p><code>&#123;flutter_sdk&#125;/bin/dart</code>对<code>dart-sdk</code>的工具做了一层包装，执行的时候会调用<code>dart-sdk</code>中的工具。</p>
<blockquote>
<p>由于配置Flutter SDK环境变量<code>&#123;flutter_sdk&#125;/bin</code>的时候没有配置<code>dart-sdk</code>的环境变量，如果要使用<code>dartaotruntime</code>工具，需要进入对应目录执行，或者给<code>dart-sdk</code>也配置环境变量</p>
</blockquote>
<h1 id="Dart的编译和执行"><a href="#Dart的编译和执行" class="headerlink" title="Dart的编译和执行"></a>Dart的编译和执行</h1><h2 id="Dart虚拟机"><a href="#Dart虚拟机" class="headerlink" title="Dart虚拟机"></a>Dart虚拟机</h2><p>Dart虚拟机源码位于<code>&#123;dart_sdk&#125;/runtime/vm</code>中，包含以下几个部分：</p>
<p><img src="/2022/01/05/flutter-2022-01-05-Dart%E7%9A%84%E7%BC%96%E8%AF%91%E5%92%8C%E6%89%A7%E8%A1%8C/DartVM.png"></p>
<p>DartVM作为虚拟机为Dart高级语言提供执行环境，但这并不表示Dart一定运行在虚拟机中。Dart的运行主要有几种方式：</p>
<ul>
<li>虚拟机执行：通过JIT即时编译+解释器，执行Dart源文件或者Kernel二进制文件，运行在Dart虚拟机中。对应<code>dart run</code>命令</li>
<li>目标代码执行：通过AOT预编译成目标代码，运行在预编译运行时环境（Precompiled Runtime）中。不包含编译器，因此无法动态加载Dart源码。对应<code>dartaotruntime</code>命令</li>
</ul>
<blockquote>
<ul>
<li>开发阶段：运行在Dart虚拟机中，通过Dart虚拟机提供的即时编译器（JIT）执行，支持增量编译，热重载和调试。</li>
<li>发布阶段：通过Dart的AOT编译器编译成目标平台的代码，在Dart预编译运行时（Precompiled Runtime）中执行，提高启动速度和执行效率。</li>
</ul>
<p>Dart 2之后，Dart VM不支持直接执行源代码，只接收Kernel AST序列化成的Kernel二进制文件（即.dill文件）。通过Dart的<a target="_blank" rel="noopener" href="https://github.com/dart-lang/sdk/tree/master/pkg/front_end">编译前端（CFE，common front-end）</a>编译，并被其他工具所依赖使用，例如Dart VM、dart2js、Dart Dev Compiler。</p>
</blockquote>
<p>Dart运行时会被打包到<code>Self-Contained</code>的目标可执行程序中，同时也是Dart虚拟机的一部分，包含以下功能</p>
<ul>
<li>内存管理：提供对象分配和分代垃圾回收功能。</li>
<li>运行时类型检查和强制转换</li>
<li>管理<code>isolates</code>：包括主isolate和应用自行创建的isolate</li>
</ul>
<h2 id="虚拟机执行"><a href="#虚拟机执行" class="headerlink" title="虚拟机执行"></a>虚拟机执行</h2><p>使用<code>dart run</code>命令启动虚拟机执行程序，如下</p>
<ol>
<li><p>新建<code>main.dart</code>文件</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//main.dart</span></span><br><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&#x27;Hello, World!&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>执行<code>dart main.dart</code>，输出”Hello, World!”</p>
</li>
</ol>
<blockquote>
<p>run子命令启动一个Dart虚拟机，执行未编译过的源码或者部分快照类型（JIT、Kernel快照），不支持执行aot快照。</p>
<p>可以省略，例如<code>dart main.dart</code>，<code>dart main.dill</code></p>
</blockquote>
<h2 id="Dart编译"><a href="#Dart编译" class="headerlink" title="Dart编译"></a>Dart编译</h2><h3 id="compile命令"><a href="#compile命令" class="headerlink" title="compile命令"></a>compile命令</h3><p><code>dart compile</code>命令封装了不同场景下的编译，不需要手动执行编译前端和编译后端。源码位于<code>&#123;dart_sdk&#125;/pkg/dartdev/lib/src/commands/compile.dart</code>，分为以下几种方式：</p>
<ol>
<li><code>exe</code>：生成<code>Self-Contained</code>可执行文件，<strong>包含生成的目标代码和一个小型的Dart运行时</strong>，可以直接运行<ol>
<li>编译：<code>dart compile exe main.dart</code>，生成<code>main.exe</code>文件</li>
<li>运行：<code>./main.exe</code>，输出”Hello, World!”</li>
</ol>
</li>
<li><code>aot-snapshot</code>：生成AOT快照文件，<strong>包含生成的目标代码，但不包含Dart运行时</strong>，需要使用<code>dartaotruntime</code>执行<ol>
<li>编译：<code>dart compile aot-snapshot main.dart</code>，生成<code>main.aot</code>文件</li>
<li>执行<code>dartaotruntime main.aot</code>，输出”Hello, World!”</li>
</ol>
</li>
<li><code>jit-snapshot</code>：生成JIT快照文件，<strong>包含生成的目标代码，不同的是在训练运行期间已经加载和解析过代码</strong>，使用<code>dart run</code>运行。由于在训练运行期间已经解析和编译过，Dart虚拟机不需要再进行解析和编译，因此可以更快的执行代码。（经过训练和优化，有可能比aot执行更快）<ol>
<li>编译：<code>dart compile jit-snapshot main.dart</code>，生成<code>main.jit</code>文件，并且会执行一遍程序训练，输出”Hello, World!”</li>
<li>运行：<code>dart run main.jit</code>，输出”Hello, World!”</li>
</ol>
</li>
<li><code>kernel</code>：生成<code>.dill</code>二进制的kernel快照文件，<strong>是一种中间代码，和平台无关，具有可移植性</strong>。包含二进制格式的Dart抽象语法树（Kernel AST）<ol>
<li>编译：<code>dart compile kernel main.dart</code>，生成<code>main.dill</code>文件</li>
<li>执行：<code>dart run main.dill</code>，输出”Hello, World!”</li>
</ol>
</li>
<li><code>js</code>：生成js文件<ol>
<li>编译：<code>dart compile js main.dart</code>，生成<code>out.js</code>文件</li>
<li>可以使用<code>webdev serve</code>命令启动开发服务器运行js</li>
</ol>
</li>
</ol>
<p><code>exe</code>和<code>aot-snapshot</code>存在一些限制：</p>
<ol>
<li>不支持交叉编译、只能本地编译本地运行：需要在macOS、Windows、Linux主机上分别编译出三个目标程序</li>
<li>生成的可执行程序不支持签名</li>
<li>不支持<code>dart:mirrors</code>（用于动态反射）和<code>dart:developer</code>（用于调试检查）库，参考<a target="_blank" rel="noopener" href="https://dart.dev/guides/libraries">Dart核心库</a>说明</li>
</ol>
<p>对比下编译产物文件，如下：<code>exe &gt; jit-snapshot &gt; aot-snapshot &gt; kernel &gt; dart source code</code>，一般情况下执行效率刚好相反。</p>
<p><img src="/2022/01/05/flutter-2022-01-05-Dart%E7%9A%84%E7%BC%96%E8%AF%91%E5%92%8C%E6%89%A7%E8%A1%8C/dart%E7%BC%96%E8%AF%91%E4%BA%A7%E7%89%A9%E6%96%87%E4%BB%B6.png"></p>
<p>查看<code>dart compile</code>源码，如下：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//&#123;dart_sdk&#125;/pkg/dartdev/lib/src/commands/compile.dart</span></span><br><span class="line"><span class="comment">//dart compile命令</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CompileCommand</span> <span class="keyword">extends</span> <span class="title">DartdevCommand</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">String</span> cmdName = <span class="string">&#x27;compile&#x27;</span>;</span><br><span class="line">  CompileCommand(&#123;<span class="built_in">bool</span> verbose = <span class="keyword">false</span>&#125;)</span><br><span class="line">      : <span class="keyword">super</span>(cmdName, <span class="string">&#x27;Compile Dart to various formats.&#x27;</span>, verbose) &#123;</span><br><span class="line">    addSubcommand(CompileJSCommand(verbose: verbose));</span><br><span class="line">    addSubcommand(CompileSnapshotCommand( <span class="comment">//dart compile jit-snapshot子命令</span></span><br><span class="line">      commandName: CompileSnapshotCommand.jitSnapshotCmdName,</span><br><span class="line">      help: <span class="string">&#x27;to a JIT snapshot.\n&#x27;</span></span><br><span class="line">          <span class="string">&#x27;To run the snapshot use: dart run &lt;JIT file&gt;&#x27;</span>,</span><br><span class="line">      fileExt: <span class="string">&#x27;jit&#x27;</span>,</span><br><span class="line">      formatName: <span class="string">&#x27;app-jit&#x27;</span>,</span><br><span class="line">      verbose: verbose,</span><br><span class="line">    ));</span><br><span class="line">    addSubcommand(CompileSnapshotCommand( <span class="comment">//dart compile kernel子命令</span></span><br><span class="line">      commandName: CompileSnapshotCommand.kernelCmdName,</span><br><span class="line">      help: <span class="string">&#x27;to a kernel snapshot.\n&#x27;</span></span><br><span class="line">          <span class="string">&#x27;To run the snapshot use: dart run &lt;kernel file&gt;&#x27;</span>,</span><br><span class="line">      fileExt: <span class="string">&#x27;dill&#x27;</span>,</span><br><span class="line">      formatName: <span class="string">&#x27;kernel&#x27;</span>,</span><br><span class="line">      verbose: verbose,</span><br><span class="line">    ));</span><br><span class="line">    addSubcommand(CompileNativeCommand(</span><br><span class="line">      commandName: CompileNativeCommand.exeCmdName,</span><br><span class="line">      help: <span class="string">&#x27;to a self-contained executable.&#x27;</span>,</span><br><span class="line">      format: <span class="string">&#x27;exe&#x27;</span>,</span><br><span class="line">      verbose: verbose,</span><br><span class="line">    ));</span><br><span class="line">    addSubcommand(CompileNativeCommand(</span><br><span class="line">      commandName: CompileNativeCommand.aotSnapshotCmdName,</span><br><span class="line">      help: <span class="string">&#x27;to an AOT snapshot.\n&#x27;</span></span><br><span class="line">          <span class="string">&#x27;To run the snapshot use: dartaotruntime &lt;AOT snapshot file&gt;&#x27;</span>,</span><br><span class="line">      format: <span class="string">&#x27;aot&#x27;</span>,</span><br><span class="line">      verbose: verbose,</span><br><span class="line">    ));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="dart-–snapshot"><a href="#dart-–snapshot" class="headerlink" title="dart –snapshot"></a>dart –snapshot</h3><p>在Flutter SDK中经常看到<code>.snapshot</code>后缀的文件，如<code>flutter_tools.snapshot</code>，查看Flutter命令脚本的源码中使用了<code>dart --snapshot</code>命令，官网没有说明。使用<code>dart --snapshot</code>查看帮助如下：</p>
<p><img src="/2022/01/05/flutter-2022-01-05-Dart%E7%9A%84%E7%BC%96%E8%AF%91%E5%92%8C%E6%89%A7%E8%A1%8C/dart%E5%91%BD%E4%BB%A4%E5%B8%AE%E5%8A%A9.png"></p>
<p><code>--snapshot</code>用于生成快照文件，<code>--snapshot-kind</code>指定生成JIT快照还是kernel快照。默认生成kernel快照。</p>
<blockquote>
<p><code>dart --snapshot</code>源码入口位于<code>&#123;dart-sdk&#125;/runtime/bin/main.cc</code></p>
</blockquote>
<h3 id="CompileSnapshotCommand"><a href="#CompileSnapshotCommand" class="headerlink" title="CompileSnapshotCommand"></a>CompileSnapshotCommand</h3><p>查看<code>CompileSnapshotCommand</code>代码，对应<code>dart compile kernel</code>和<code>dart compile jit-snapshot</code>命令。实际就是调用<code>dart --snapshot-kind=$formatName</code>执行。如下：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//&#123;dart_sdk&#125;/pkg/dartdev/lib/src/commands/compile.dart</span></span><br><span class="line"><span class="comment">//jit和kernel编译</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CompileSnapshotCommand</span> <span class="keyword">extends</span> <span class="title">CompileSubcommandCommand</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">String</span> jitSnapshotCmdName = <span class="string">&#x27;jit-snapshot&#x27;</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">String</span> kernelCmdName = <span class="string">&#x27;kernel&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> commandName;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> help;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> fileExt;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> formatName;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  FutureOr&lt;<span class="built_in">int</span>&gt; run() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="comment">//调用dart --snapshot-kind=$formatName</span></span><br><span class="line">    <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; args = [];</span><br><span class="line">    args.add(<span class="string">&#x27;--snapshot-kind=<span class="subst">$formatName</span>&#x27;</span>);</span><br><span class="line">    args.add(<span class="string">&#x27;--snapshot=<span class="subst">$&#123;path.canonicalize(outputFile)&#125;</span>&#x27;</span>);</span><br><span class="line">    <span class="keyword">final</span> process = <span class="keyword">await</span> startDartProcess(sdk, args);</span><br><span class="line">    <span class="keyword">return</span> process.exitCode;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>dart compile kernel/jit-snapshot</code>等价于<code>dart --snapshot-kind=kernel/app-jits</code>。只不过是新版本Dart工具统一封装到compile中而已。</p>
<blockquote>
<p>例如<code>dart --snapshot=main.snapshot main.dart</code>生成<code>main.snapshot</code>，<code>dart compile kernel main.dart</code>生成<code>main.dill</code>。<code>main.dill</code>和<code>main.snapshot</code>实际上是一样的，都是Kernel快照文件，文件大小也相同。</p>
</blockquote>
<h3 id="CompileNativeCommand"><a href="#CompileNativeCommand" class="headerlink" title="CompileNativeCommand"></a>CompileNativeCommand</h3><p>查看<code>CompileNativeCommand</code>代码，对应<code>dart compile aot</code>和<code>dart compile exe</code>命令，调用了<code>dart2native</code>的<code>generateNative</code>方法，</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//&#123;dart_sdk&#125;/pkg/dartdev/lib/src/commands/compile.dart</span></span><br><span class="line"><span class="comment">//exe和aot编译</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CompileNativeCommand</span> <span class="keyword">extends</span> <span class="title">CompileSubcommandCommand</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">String</span> exeCmdName = <span class="string">&#x27;exe&#x27;</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">String</span> aotSnapshotCmdName = <span class="string">&#x27;aot-snapshot&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> commandName;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> format;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> help;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  FutureOr&lt;<span class="built_in">int</span>&gt; run() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> generateNative(</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      log.stderr(<span class="string">&#x27;Error: AOT compilation failed&#x27;</span>);</span><br><span class="line">      log.stderr(e.toString());</span><br><span class="line">      <span class="keyword">return</span> compileErrorExitCode;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>generateNative</code>流程如下：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//&#123;dart-sdk&#125;/pkg/dart2native/lib/generate.dart</span></span><br><span class="line"><span class="keyword">final</span> Directory binDir = File(Platform.resolvedExecutable).parent;</span><br><span class="line"><span class="keyword">final</span> <span class="built_in">String</span> executableSuffix = Platform.isWindows ? <span class="string">&#x27;.exe&#x27;</span> : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">final</span> <span class="built_in">String</span> dartaotruntime = path.join(binDir.path, <span class="string">&#x27;dartaotruntime<span class="subst">$executableSuffix</span>&#x27;</span>);</span><br><span class="line"><span class="keyword">final</span> <span class="built_in">String</span> genKernel = path.join(binDir.path, <span class="string">&#x27;snapshots&#x27;</span>, <span class="string">&#x27;gen_kernel.dart.snapshot&#x27;</span>);</span><br><span class="line"><span class="keyword">final</span> <span class="built_in">String</span> genSnapshot = path.join(binDir.path, <span class="string">&#x27;utils&#x27;</span>, <span class="string">&#x27;gen_snapshot<span class="subst">$executableSuffix</span>&#x27;</span>);</span><br><span class="line"><span class="keyword">final</span> <span class="built_in">String</span> productPlatformDill = path.join(binDir.parent.path, <span class="string">&#x27;lib&#x27;</span>, <span class="string">&#x27;_internal&#x27;</span>, <span class="string">&#x27;vm_platform_strong_product.dill&#x27;</span>);</span><br><span class="line"></span><br><span class="line">Future&lt;<span class="keyword">void</span>&gt; generateNative(&#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">&#125;) <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">String</span> kernelFile = path.join(tempDir.path, <span class="string">&#x27;kernel.dill&#x27;</span>);</span><br><span class="line">    <span class="comment">//1. 编译前端，生成kernel文件：执行gen_kernel.dart.snapshot程序，最终会调用front_end方法</span></span><br><span class="line">    <span class="keyword">final</span> kernelResult = <span class="keyword">await</span> generateAotKernel(Platform.executable, genKernel,</span><br><span class="line">        productPlatformDill, sourcePath, kernelFile, packages, defines,</span><br><span class="line">        enableExperiment: enableExperiment,</span><br><span class="line">        extraGenKernelOptions: [</span><br><span class="line">          <span class="string">&#x27;--invocation-modes=compile&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;--verbosity=<span class="subst">$verbosity</span>&#x27;</span>,</span><br><span class="line">          <span class="keyword">if</span> (soundNullSafety != <span class="keyword">null</span>)</span><br><span class="line">            <span class="string">&#x27;--<span class="subst">$&#123;soundNullSafety ? <span class="string">&#x27;&#x27;</span> : <span class="string">&#x27;no-&#x27;</span>&#125;</span>sound-null-safety&#x27;</span>,</span><br><span class="line">        ]);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">String</span> snapshotFile = (outputKind == Kind.aot</span><br><span class="line">        ? outputPath</span><br><span class="line">        : path.join(tempDir.path, <span class="string">&#x27;snapshot.aot&#x27;</span>));</span><br><span class="line">    <span class="comment">//2. 编译后端，生成aot目标文件：执行gen_snapshot程序</span></span><br><span class="line">    <span class="keyword">final</span> snapshotResult = <span class="keyword">await</span> generateAotSnapshot(genSnapshot, kernelFile,</span><br><span class="line">        snapshotFile, debugPath, enableAsserts, extraOptions);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">if</span> (outputKind == Kind.exe) &#123;</span><br><span class="line">      <span class="keyword">if</span> (verbose) &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Generating executable.&#x27;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//3. exe编译需要加上Dart运行时</span></span><br><span class="line">      <span class="keyword">await</span> writeAppendedExecutable(dartaotruntime, snapshotFile, outputPath);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (Platform.isLinux || Platform.isMacOS) &#123;</span><br><span class="line">        <span class="comment">//4. 标记为可执行</span></span><br><span class="line">        <span class="keyword">await</span> markExecutable(outputPath);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Generated: <span class="subst">$outputPath</span>&#x27;</span>);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    tempDir.deleteSync(recursive: <span class="keyword">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="编译流程"><a href="#编译流程" class="headerlink" title="编译流程"></a>编译流程</h3><ul>
<li><p>Dart编译前端（frontend，<code>&#123;dart_sdk&#125;/pkg/front_end/lib/src/api_prototype/front_end.dart</code>）：将Dart源码编译为Kernel二进制文件，是一种平台无关的中间代码。</p>
<blockquote>
<p>Dart编译前端生成的.dill文件类似于Java编译前端的.class文件，通过虚拟机执行，和平台无关。</p>
</blockquote>
</li>
<li><p>Dart编译后端（gen_snapshot，<code>&#123;dart_sdk&#125;/runtime/bin/gen_snapshot.cc</code>）：将Kernel二进制文件编译出目标代码</p>
<ul>
<li>将Kernel二进制代码生成一个控制流图（CFG，control flow graph），CFG由中间语言（IL，Intermediate Language）指令组成。</li>
<li>对IL指令进行优化</li>
<li>CFG编译成机器码，每个IL指令对应多个机器指令</li>
</ul>
<blockquote>
<p>IL指令类似于虚拟机指令，从堆栈中获取操作数，执行操作，将结果推送到堆栈中</p>
</blockquote>
</li>
<li><p>创建exe可执行文件：<code>writeAppendedExecutable</code>方法合并<code>dartaotruntime</code>和aot目标代码</p>
</li>
</ul>
<p>命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 编译前端1</span></span><br><span class="line">dart &#123;dart-sdk&#125;/bin/snapshots/frontend_server.dart.snapshot </span><br><span class="line">--sdk-root &#123;dart-sdk&#125;/lib/_internal/ </span><br><span class="line">--platform vm_platform_strong.dill </span><br><span class="line">--aot --tfa </span><br><span class="line">-Ddart.vm.profile=false </span><br><span class="line">-Ddart.vm.product=true </span><br><span class="line">--output-dill &#123;build_dir&#125;/app.dill </span><br><span class="line">main.dart</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 编译前端2：和方式一等价，参数稍微有些差异</span></span><br><span class="line">dart &#123;dart-sdk&#125;/bin/snapshots/gen_kernel.dart.snapshot </span><br><span class="line">--platform &#123;dart-sdk&#125;/lib/_internal/vm_platform_strong.dill </span><br><span class="line">--aot --tfa </span><br><span class="line">-Ddart.vm.profile=false </span><br><span class="line">-Ddart.vm.product=true </span><br><span class="line">-o &#123;build_dir&#125;/app.dill </span><br><span class="line">main.dart</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 编译后端</span></span><br><span class="line">&#123;dart-sdk&#125;/bin/utils/gen_snapshot </span><br><span class="line">--deterministic </span><br><span class="line">--snapshot_kind=app-aot-elf </span><br><span class="line">--elf=&#123;output_path&#125;/app.aot </span><br><span class="line">app.dill</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 运行aot文件</span></span><br><span class="line">&#123;dart-sdk&#125;/bin/dartaotruntime app.aot</span><br></pre></td></tr></table></figure>

<p><code>gen_kernel.dart.snapshot</code>和<code>frontend_server.dart.snapshot</code>都是调用<code>front_end</code>的方法（可以分析源码，或者执行命令异常查看方法调用栈），参数稍微有些差异</p>
<blockquote>
<p>例如<code>frontend_server.dart.snapshot</code>支持<code>--import-dill</code>参数，可以加载和链接其他dill文件。</p>
</blockquote>
<p><code>gen_kernel.dart.snapshot</code>的<code>--platform</code>参数用于指定sdk完整路径，用于将平台库加载到产物中。与<code>frontend_server.dart.snapshot</code>的<code>--sdk-root</code>和<code>--platform</code>参数作用相同，<code>--sdk-root</code>指定文件夹路径，<code>--platform</code>指定文件名，加起来是完整路径。</p>
<ul>
<li>Dart平台库位于<code>&#123;dart-sdk&#125;/lib/_internal/vm_platform_strong.dill</code>。</li>
<li>Flutter平台库中包含Dart库和Flutter框架本身，位于<code>&#123;flutter_sdk&#125;/bin/cache/artifacts/engine/common/flutter_patched_sdk/platform_strong.dill</code></li>
</ul>
<p><code>--target</code>参数：使用Dart平台库时，target值需要为vm，使用Flutter平台库时，target值需要为flutter，否则会编译失败。说明如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./dart-sdk/bin/dart ./dart-sdk/bin/snapshots/frontend_server.dart.snapshot -h</span></span><br><span class="line"><span class="meta">#</span><span class="bash">....</span></span><br><span class="line">--target Target model that determines what core libraries are available</span><br><span class="line">         [vm (default), flutter, flutter_runner, dart_runner, dartdevc]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>target相关源码位于<code>&#123;dart-sdk&#125;/pkg/vm/lib/target/</code>下</p>
</blockquote>
<p>注：target为flutter时，无法使用<code>dartaotruntime</code>执行aot文件，由于找不到对应的平台库，会报错<code>Dart_LookupLibrary: library &#39;dart:_builtin&#39; not found.</code>。</p>
<h3 id="Kernel文件踩坑"><a href="#Kernel文件踩坑" class="headerlink" title="Kernel文件踩坑"></a>Kernel文件踩坑</h3><ul>
<li><code>dart compile kernel</code>生成的Kernel文件不能用于<code>gen_snapshot</code>后端编译，会报错：<code>Unable to use class Library:&#39;dart:core&#39; Class: _List@0150898 which is not loaded yet.</code>。但是可以使用<code>dart run main.dill</code>运行。</li>
<li>编译前端<code>--no-aot</code>参数生成的Kernel文件不能用于<code>gen_snapshot</code>后端编译，会报错：<code>error: Missing table selector metadata! Probably gen_kernel was run in non-AOT mode or without TFA.</code>。但是可以使用<code>dart run main.dill</code>运行</li>
<li>编译前端<code>--aot</code>参数生成的Kernel文件可以用于<code>gen_snapshot</code>后端编译，但是不能直接用dart运行，会报错：<code>error: vm.procedure-attributes.metadata metadata is allowed in precompiled mode only</code></li>
</ul>
<blockquote>
<p>上述三者都生成了Kernel文件，但是不太一样。具体区别暂时不清楚。</p>
</blockquote>
<h3 id="Dart-SDK版本一致"><a href="#Dart-SDK版本一致" class="headerlink" title="Dart SDK版本一致"></a>Dart SDK版本一致</h3><p>Dart编译前端、编译后端、以及Dart运行时的版本必须一致，否则会报错版本不匹配。例如</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Dart运行不同版本的编译前端报错</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> dart ~/Flutter/engine/src/out/host_debug_unopt/dart-sdk/bin/snapshots/frontend_server.dart.snapshot --sdk-root ./ --target=flutter -Ddart.vm.profile=<span class="literal">false</span> -Ddart.vm.product=<span class="literal">false</span> --aot --tfa --output-dill ~/Desktop/bin/main.dill ~/Desktop/bin/main.dart</span></span><br><span class="line">Wrong full snapshot version, expected &#x27;9cf77f4405212c45daf608e1cd646852&#x27; found &#x27;d56742caf7b3b3f4bd2df93a9bbb5503&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> gen_snapshot编译不同版本的dill文件报错</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ~/Flutter/flutter/bin/cache/dart-sdk/bin/utils/gen_snapshot --snapshot_kind=app-aot-elf --elf=main.aot main.dill</span></span><br><span class="line">Can&#x27;t load Kernel binary: Invalid kernel binary format version.</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Dart执行不同版本的dill文件报错</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> dart main.dill</span></span><br><span class="line">Can&#x27;t load Kernel binary: Invalid kernel binary format version.</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Dart预编译运行时执行不同版本的aot文件报错</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ~/Flutter/engine/src/out/host_debug_unopt/dart-sdk/bin/dartaotruntime main.aot</span></span><br><span class="line">VM initialization failed: Wrong full snapshot version, expected &#x27;d56742caf7b3b3f4bd2df93a9bbb5503&#x27; found &#x27;9cf77f4405212c45daf608e1cd646852&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>生成的dill文件和aot文件中带了版本信息，执行的时候会进行校验。</p>
<p>主机上有多个版本Dart SDK，例如Flutter引擎编译出来的Dart SDK和Flutter SDK中内置的Dart SDK版本不一致。此时需要分别进入对应路径下执行命令，或者配置多个环境变量。为了避免麻烦，可以切换Flutter引擎到对应的commit id，保持版本一致。</p>
</blockquote>
<h2 id="Web平台"><a href="#Web平台" class="headerlink" title="Web平台"></a>Web平台</h2><p>dart支持在Web平台上执行，既不是JIT也不是AOT：生成JavaScript代码，运行在浏览器中，而不是目标平台代码</p>
<ol>
<li>开发阶段使用<code>dartdevc</code>增量式编译器</li>
<li>生产环境使用<code>dart2js</code>编译器，高版本替换为<code>dart compile js</code>命令</li>
</ol>
<p>官方建议使用<a target="_blank" rel="noopener" href="https://dart.dev/tools/webdev">webdev</a>工具，而不是直接使用<code>dartdevc</code>和<code>dart2js</code>工具。</p>
<ul>
<li><code>webdev serve</code>：编译并部署到开发服务器，使用<code>localhost:8080</code>访问。默认使用<code>dartdevc</code>编译。添加<code>--release</code>选项，替换为<code>dart2js</code>编译</li>
<li><code>webdev build</code>：默认使用<code>dart2js</code>编译，添加<code>--no-release</code>选项，替换为<code>dartdevc</code>编译</li>
</ul>
<h1 id="Dart源码下载和编译"><a href="#Dart源码下载和编译" class="headerlink" title="Dart源码下载和编译"></a>Dart源码下载和编译</h1><p>Dart SDK是Dart源码的编译产物。</p>
<h2 id="源码下载和编译"><a href="#源码下载和编译" class="headerlink" title="源码下载和编译"></a>源码下载和编译</h2><ol>
<li><p>安装<code>depot_tools</code></p>
<ol>
<li>下载：<code>git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git</code></li>
<li>设置环境变量：<code>.bash_profile</code>文件中添加<code>export PATH=/your_path/depot_tools/:$PATH</code></li>
</ol>
</li>
<li><p>下载Dart源码和DEPS依赖</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建目录</span></span><br><span class="line">mkdir dart-sdk</span><br><span class="line">cd dart-sdk</span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过gclient下载dart源码和DEPS依赖</span></span><br><span class="line">fetch dart</span><br></pre></td></tr></table></figure></li>
<li><p>编译Dart SDK源码，生成Dart SDK归档文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd sdk</span><br><span class="line">./tools/build.py --no-goma --mode release --arch x64 create_sdk</span><br><span class="line"><span class="meta">#</span><span class="bash"> 也可以指定多个build_targets编译</span></span><br><span class="line">./tools/build.py --mode=release --arch=x64 create_sdk runtime gen_snapshot frontend_server.dart.snapshot</span><br></pre></td></tr></table></figure></li>
</ol>
<blockquote>
<p><code>build_targets</code>参数没有找到具体说明，不过可以参考<code>tools/bots/test_matrix.json</code>文件中的<code>builder_configurations</code></p>
<p>踩坑：FlutterEngine中下载的Dart SDK（<code>&#123;flutter_engine&#125;/src/third_party/dart</code>）不包含编译需要的依赖项目，无法直接用于编译，因此需要使用<code>gclient</code>重新下载Dart源码。</p>
<p>应该也可以手动创建<code>.gclient</code>文件，执行<code>gclient sync</code>下载依赖</p>
</blockquote>
<h2 id="交叉编译"><a href="#交叉编译" class="headerlink" title="交叉编译"></a>交叉编译</h2><h3 id="编译生成Dart虚拟机"><a href="#编译生成Dart虚拟机" class="headerlink" title="编译生成Dart虚拟机"></a>编译生成Dart虚拟机</h3><p>交叉编译Android平台的Dart VM，可以在Android平台执行Dart应用程序</p>
<ol>
<li>下载Android需要的依赖，如NDK，SDK等<ol>
<li>修改dart-sdk目录下的<code>.gclient</code>文件：最后一行添加<code>target_os = [&#39;android&#39;]</code></li>
<li>下载依赖项目：执行<code>gclient sync</code></li>
</ol>
</li>
<li>交叉编译Arm64的Android平台的Dart VM：<code>./tools/build.py --no-goma --arch=arm64 --mode=release --os=android runtime</code></li>
<li>使用adb将编译后的Dart VM工具push到Android平台中：<code>adb push ./xcodebuild/ReleaseAndroidARM64/dart /data/local/tmp/dart</code></li>
<li>将Dart程序push到Android平台中：<code>adb push main.dart /data/local/tmp/</code></li>
<li>运行Dart程序：<code>adb shell /data/local/tmp/dart /data/local/tmp/main.dart</code></li>
</ol>
<blockquote>
<p>踩坑：这里无法使用adb shell进入Android终端执行，会报错，缺少工具和库。</p>
</blockquote>
<h3 id="编译生成Dart-SDK"><a href="#编译生成Dart-SDK" class="headerlink" title="编译生成Dart SDK"></a>编译生成Dart SDK</h3><p>可以将编译出来的整个SDK归档文件push到Android平台中并设置环境变量，此时可以像在主机上一样使用Dart SDK，编译和执行Dart应用。如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 交叉编译Android平台的Dart SDK</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./tools/build.py --no-goma -a=arm64 --mode=release --os=android create_sdk</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> adb push ./xcodebuild/ReleaseAndroidARM64/dart-sdk/ /data/<span class="built_in">local</span>/tmp/dart-sdk/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> adb shell</span></span><br><span class="line">HWAUM-Q:/ $ cd /data/local/tmp</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置环境变量</span></span><br><span class="line">HWAUM-Q:/data/local/tmp $ export PATH=&quot;$PATH:$PWD/dart-sdk/bin&quot;</span><br><span class="line"><span class="meta">#</span><span class="bash"> Dart虚拟机执行，输出Hello World</span></span><br><span class="line">HWAUM-Q:/data/local/tmp $ dart run main.dart</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 编译aot快照</span></span><br><span class="line">HWAUM-Q:/data/local/tmp $ dart compile aot-snapshot main.dart</span><br><span class="line"><span class="meta">#</span><span class="bash"> 执行aot文件，输出Hello World</span></span><br><span class="line">HWAUM-Q:/data/local/tmp $ dartaotruntime main.aot</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 编译exe可执行程序</span></span><br><span class="line">HWAUM-Q:/data/local/tmp $ dart compile exe main.dart</span><br><span class="line"><span class="meta">#</span><span class="bash"> 执行exe程序，输出Hello World</span></span><br><span class="line">HWAUM-Q:/data/local/tmp $ ./main.exe</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> dart编译前端，生成main.dill</span></span><br><span class="line">HWAUM-Q:/data/local/tmp $ dart dart-sdk/bin/snapshots/frontend_server.dart.snapshot --sdk-root dart-sdk/lib/_internal/ --platform vm_platform_strong.dill --aot --tfa -Ddart.vm.product=true --output-dill main.dill main.dart</span><br><span class="line"><span class="meta">#</span><span class="bash"> dart编译后端，生成main.aot</span></span><br><span class="line">HWAUM-Q:/data/local/tmp $ ./dart-sdk/bin/utils/gen_snapshot --snapshot_kind=app-aot-elf --elf=main.aot main.dill</span><br><span class="line"><span class="meta">#</span><span class="bash"> 执行main.aot文件，输出Hello World</span></span><br><span class="line">HWAUM-Q:/data/local/tmp $ dartaotruntime main.aot</span><br></pre></td></tr></table></figure>

<h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h1><p>了解Dart编译方式和不同产物，以及执行原理，主要有以下场景</p>
<ol>
<li>为动态化，分包等提供一些思路</li>
<li>使用交叉编译在嵌入式平台中执行Dart或Flutter程序</li>
<li>定制虚拟机、编译器等。</li>
</ol>
<p>参考资料：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://dart.dev/overview">Dart官网</a></li>
<li><a target="_blank" rel="noopener" href="https://mrale.ph/dartvm/">Introduction to Dart VM</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/dart-lang/sdk/wiki">Dart Wiki</a>、<a target="_blank" rel="noopener" href="https://github.com/dart-lang/sdk/wiki/Building">Dart Building</a>、<a target="_blank" rel="noopener" href="https://github.com/dart-lang/sdk/wiki/Building-the-Dart-VM-for-Android">Building the Dart VM for Android</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/a5b1997a01ba">Dart VM介绍</a></li>
</ul>

    </div>

    
    
    
        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/images/wechat_channel.jpg">
            <span class="icon">
              <i class="fab fa-weixin"></i>
            </span>

            <span class="label">WeChat</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/Flutter/" rel="tag"><i class="fa fa-tag"></i> Flutter</a>
              <a href="/tags/Dart/" rel="tag"><i class="fa fa-tag"></i> Dart</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/01/04/tool-2022-01-04-depot-tools/" rel="prev" title="depot_tools工具介绍">
      <i class="fa fa-chevron-left"></i> depot_tools工具介绍
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/01/06/flutter-2022-01-06-Flutter%E6%BA%90%E7%A0%81%E4%B8%8B%E8%BD%BD%E5%92%8C%E7%BC%96%E8%AF%91/" rel="next" title="Flutter源码下载和编译">
      Flutter源码下载和编译 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="header-overlay"></div>
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Dart%E7%AE%80%E4%BB%8B"><span class="nav-number">1.</span> <span class="nav-text">Dart简介</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Dart-SDK%E5%AE%89%E8%A3%85"><span class="nav-number">1.1.</span> <span class="nav-text">Dart SDK安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dart%E8%AF%AD%E8%A8%80"><span class="nav-number">1.2.</span> <span class="nav-text">Dart语言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dart%E5%BA%93"><span class="nav-number">1.3.</span> <span class="nav-text">Dart库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dart%E9%A1%B9%E7%9B%AE%E6%96%87%E4%BB%B6"><span class="nav-number">1.4.</span> <span class="nav-text">Dart项目文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dart%E5%B7%A5%E5%85%B7"><span class="nav-number">1.5.</span> <span class="nav-text">Dart工具</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Dart%E7%9A%84%E7%BC%96%E8%AF%91%E5%92%8C%E6%89%A7%E8%A1%8C"><span class="nav-number">2.</span> <span class="nav-text">Dart的编译和执行</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Dart%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="nav-number">2.1.</span> <span class="nav-text">Dart虚拟机</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%89%A7%E8%A1%8C"><span class="nav-number">2.2.</span> <span class="nav-text">虚拟机执行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dart%E7%BC%96%E8%AF%91"><span class="nav-number">2.3.</span> <span class="nav-text">Dart编译</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#compile%E5%91%BD%E4%BB%A4"><span class="nav-number">2.3.1.</span> <span class="nav-text">compile命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dart-%E2%80%93snapshot"><span class="nav-number">2.3.2.</span> <span class="nav-text">dart –snapshot</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CompileSnapshotCommand"><span class="nav-number">2.3.3.</span> <span class="nav-text">CompileSnapshotCommand</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CompileNativeCommand"><span class="nav-number">2.3.4.</span> <span class="nav-text">CompileNativeCommand</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B"><span class="nav-number">2.3.5.</span> <span class="nav-text">编译流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kernel%E6%96%87%E4%BB%B6%E8%B8%A9%E5%9D%91"><span class="nav-number">2.3.6.</span> <span class="nav-text">Kernel文件踩坑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dart-SDK%E7%89%88%E6%9C%AC%E4%B8%80%E8%87%B4"><span class="nav-number">2.3.7.</span> <span class="nav-text">Dart SDK版本一致</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Web%E5%B9%B3%E5%8F%B0"><span class="nav-number">2.4.</span> <span class="nav-text">Web平台</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Dart%E6%BA%90%E7%A0%81%E4%B8%8B%E8%BD%BD%E5%92%8C%E7%BC%96%E8%AF%91"><span class="nav-number">3.</span> <span class="nav-text">Dart源码下载和编译</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E4%B8%8B%E8%BD%BD%E5%92%8C%E7%BC%96%E8%AF%91"><span class="nav-number">3.1.</span> <span class="nav-text">源码下载和编译</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91"><span class="nav-number">3.2.</span> <span class="nav-text">交叉编译</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E7%94%9F%E6%88%90Dart%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="nav-number">3.2.1.</span> <span class="nav-text">编译生成Dart虚拟机</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E7%94%9F%E6%88%90Dart-SDK"><span class="nav-number">3.2.2.</span> <span class="nav-text">编译生成Dart SDK</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BB%93%E8%AF%AD"><span class="nav-number">4.</span> <span class="nav-text">结语</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Afauria"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Afauria</p>
  <div class="site-description" itemprop="description">君は空を見てるか,<br>風の音を聞いてるか</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">87</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">40</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://afauria.github.io/images/wechat_channel.jpg" title="WeChat → https:&#x2F;&#x2F;afauria.github.io&#x2F;images&#x2F;wechat_channel.jpg" rel="noopener" target="_blank"><i class="fab fa-weixin fa-fw"></i>WeChat</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://afauria.github.io/images/qq_channel.jpg" title="QQ → https:&#x2F;&#x2F;afauria.github.io&#x2F;images&#x2F;qq_channel.jpg" rel="noopener" target="_blank"><i class="fab fa-qq fa-fw"></i>QQ</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:afauria@foxmail.com" title="E-Mail → mailto:afauria@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://afauria.github.io/KnowledgeTree/" title="https:&#x2F;&#x2F;Afauria.github.io&#x2F;KnowledgeTree&#x2F;" rel="noopener" target="_blank">基础知识和知识体系整理</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://blog.nowcoder.net/afauria" title="https:&#x2F;&#x2F;blog.nowcoder.net&#x2F;afauria" rel="noopener" target="_blank">牛客笔记</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="/collection/" title="&#x2F;collection&#x2F;">站点和在线工具收藏</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="/software/" title="&#x2F;software&#x2F;">软件和工具收藏</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="/2018/01/01/reader-2018-01-01-%E9%98%85%E8%AF%BB%E6%8E%A8%E8%8D%90/" title="&#x2F;2018&#x2F;01&#x2F;01&#x2F;reader-2018-01-01-阅读推荐&#x2F;">阅读推荐</a>
        </li>
    </ul>
  </div>

<div class="poem-side">
  <div id="hitokoto">loading...</div>
  <div id="hitokotofrom"></div>
  <script defer>
  fetch('https://v1.hitokoto.cn')
    .then(response => response.json())
    .then(data => {
       	hitokoto.innerHTML = data.hitokoto
    	if(data.from_who != null) {
      	  hitokotofrom.innerHTML ='——' + data.from_who + ' 《' + data.from + '》'
      	} else {
	  hitokotofrom.innerHTML ='——《' + data.from + '》' 
      }
    })
    .catch(console.error) 
</script>
</div>
      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Afauria</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">541k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">8:12</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>











<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '8Qjq2Vf2w7KNW5bzIqHqU6pN-9Nh9j0Va',
      appKey     : 'WenmbfoBFKOabxRfCbgv7KgE',
      placeholder: "欢迎留言、互链",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

  <a target="_blank" rel="noopener" href="https://github.com/Afauria" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true,"scale":0.5},"react":{"opacity":0.7},"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/"});</script></body>
</html>
